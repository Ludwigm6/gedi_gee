// INPUT -------------------------------


// input granules
// granule format: ["Name", "Date"]


//var gedi_granules = require("users/Ludwigm6/gedi:gedi_granules")
/*
var gedi_granules = require("users/alicezglr/default:granule_list")
var granules = gedi_granules.granules
*/

var granules = [
  ['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019253002511_O04210_02_T00809_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019282143448_O04669_03_T05171_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019302045500_O04973_02_T05384_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019212174240_O03585_03_T02952_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019243064956_O04059_03_T01897_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019322230752_O05295_03_T03121_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019150181219_O02623_03_T03717_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019124040434_O02210_02_T00029_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019294080952_O04851_02_T05583_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019280130418_O04637_02_T03364_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019305053754_O05020_03_T03595_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019328182331_O05385_02_T01115_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019287120954_O04745_03_T00917_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019223132943_O03753_03_T05186_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019275152858_O04561_02_T00656_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019189034415_O03219_03_T03947_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019321204934_O05278_02_T05139_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019196225104_O03340_02_T04665_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019314000252_O05156_02_T01375_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019348115134_O05691_03_T03564_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019275170148_O04562_03_T04926_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019158131745_O02744_02_T00319_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019246025356_O04103_02_T03104_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019293103015_O04837_03_T04605_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019313022304_O05142_03_T04819_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019204193034_O03462_02_T00962_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019166130117_O02868_03_T02616_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019112075017_O02026_02_T00059_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019226110446_O03798_02_T01008_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019209170158_O03538_02_T04435_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019133011454_O02348_03_T02294_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019111083958_O02011_02_T04619_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019313005014_O05141_02_T00549_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019145204136_O02547_03_T04513_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019118055729_O02118_02_T00044_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019307022954_O05049_02_T05399_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019163122106_O02821_02_T02523_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019228123430_O03830_03_T02815_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019162144219_O02807_03_T01392_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019323222029_O05310_03_T05370_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019165104412_O02851_02_T04481_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019329173607_O05400_02_T03211_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019194225448_O03309_02_T05552_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019153171951_O02669_03_T02539_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019205184217_O03477_02_T00518_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019286125727_O04730_03_T04207_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019310031246_O05096_03_T03610_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019183035532_O03126_02_T01069_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019114074336_O02057_02_T02477_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2019336164238_O05508_03_T00611_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020224112255_O09427_02_T05583_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020079220313_O07186_03_T00657_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020304050047_O10663_03_T10526_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020060055219_O06881_03_T03044_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020039142704_O06561_03_T02371_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020196235521_O09001_03_T00244_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020271164318_O10159_02_T09546_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020056055308_O06819_02_T03196_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020318215729_O10891_02_T08888_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020145185025_O08207_02_T02676_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020306032711_O10693_02_T10602_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020189013049_O08878_02_T04512_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020312015204_O10785_03_T07986_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020134010622_O08025_03_T04911_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020118055030_O07780_02_T04451_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020256220721_O09930_02_T06409_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020356092921_O11472_03_T10542_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020239072800_O09657_03_T02065_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020285103155_O10372_02_T06470_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020169092317_O08573_02_T00595_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020127015517_O07917_02_T01161_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020174083439_O08650_03_T02998_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020130024041_O07964_03_T00489_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020150180202_O08284_03_T02233_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020166101101_O08527_02_T02844_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020127032810_O07918_03_T05431_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020187013048_O08847_02_T00166_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020357070948_O11486_02_T09791_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020150162909_O08283_02_T05078_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020247042035_O09779_03_T06334_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020075002345_O07110_03_T01254_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020203195941_O09107_02_T04298_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020311010600_O10769_02_T07312_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020354075652_O11440_02_T09041_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020122054911_O07842_03_T03029_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020214173604_O09276_03_T01086_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020211165002_O09229_02_T04757_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020024182123_O06331_02_T00197_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020172100825_O08620_03_T02922_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020080194356_O07200_02_T05598_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020173092132_O08635_03_T00902_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020154162735_O08345_03_T05079_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020168114301_O08559_03_T04345_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020292081028_O10479_02_T07373_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020074225052_O07109_02_T01253_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020120041658_O07810_02_T00258_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020306050004_O10694_03_T07604_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020322215716_O10953_03_T07466_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020017204404_O06224_02_T01834_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2020336171729_O11167_03_T07237_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021192232423_O14612_02_T11214_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021279151353_O15955_03_T07895_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021361060558_O17220_03_T07160_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021339152538_O16885_03_T09777_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021272173246_O15848_03_T08721_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021088183941_O12997_03_T06625_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021350100043_O17052_03_T07680_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021137223351_O13759_03_T11322_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021365025712_O17280_02_T09041_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021069022333_O12692_03_T07237_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021008000740_O11745_02_T10770_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021094153408_O13088_03_T07971_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021019205826_O11929_03_T09501_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021161131702_O14125_03_T09287_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021143175511_O13849_02_T08398_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021314003542_O16488_03_T08690_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021209162837_O14871_02_T11275_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021260203430_O15664_02_T06792_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021225101831_O15115_02_T10663_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021241054347_O15360_03_T06900_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021257225219_O15619_03_T00657_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021291103656_O16138_03_T07436_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021332161056_O16777_02_T05522_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021170075149_O14261_02_T01574_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021074214453_O12782_02_T05736_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021019192533_O11928_02_T11076_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021108105642_O13302_03_T07589_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021272155952_O15847_02_T07450_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021253225016_O15557_02_T08230_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021018214509_O11914_03_T07405_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021158123034_O14078_02_T08689_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021353074122_O17097_02_T11275_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021271181909_O15833_03_T09471_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021010232025_O11791_02_T07251_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021169083817_O14246_02_T10709_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021150170903_O13957_03_T05997_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021026183900_O12036_03_T08675_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021313230246_O16487_02_T05843_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021060044323_O12554_03_T09409_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021186031521_O14506_03_T02233_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021132232025_O13682_02_T03380_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021320204540_O16594_02_T08980_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021138214721_O13774_03_T00458_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021229084553_O15176_02_T06241_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021252015527_O15528_03_T02769_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021340143913_O16900_03_T06334_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021097131505_O13133_02_T10143_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021089162017_O13011_02_T07450_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021293073130_O16167_02_T05935_02_003_01_V002'],
['LARSE/GEDI/GEDI02_B_002/GEDI02_B_2021222123738_O15070_03_T01529_02_003_01_V002']
];

//var granule_list = require("users/alicezglr/default/granule_list.js");
//var granules = granule_list.granules
// load hessen vector: AOI
//var hessen = ee.FeatureCollection("projects/ee-ludwigm6/assets/gedi_hessen/hessen");
var hessen = ee.FeatureCollection("users/alicezglr/hessen");

// FUNCTIONS ---------------------------

// define function for indices
var S2_SR_indices = function(img){

  var ndvi = img.expression('(NIR-RED)/(NIR+RED)', {
              'NIR': img.select('B8'),
              'RED': img.select('B4')
              }).multiply(10000).toInt16().rename('NDVI');

  var evi = img.expression(
      '2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))', {
      'NIR': img.select('B8'),
      'RED': img.select('B4'),
      'BLUE': img.select('B2')}).multiply(10000).toInt16().rename('EVI');

  var ireci = img.expression(
      '(NIR - RED)/(RE1/RE2)',{
        'NIR': img.select('B7'),
        'RED': img.select('B4'),
        'RE1': img.select('B5'),
        'RE2': img.select('B6')}).multiply(10000).toInt16().rename('IRECI');


    return img.addBands(ndvi).addBands(evi).addBands(ireci);
}

// define function for Sentinel 1
var sen1vvvh = function(image){

  var diff = image.select("VV").subtract(image.select("VH")).rename("VVsubVH")
  var rati = image.select("VV").divide(image.select("VH")).rename("VVdivVH")

  return image.addBands(diff).addBands(rati)

}

//define function to extract date of gedi orbit by name of gedi orbit
function name2date(namestring){
  var fulldt = namestring.split("_")[4].substr(0,7);
  var year = parseInt(fulldt.substr(0,4));
  var day = parseInt(fulldt.substr(4,7));
  var date = new Date(year, 0, day+1); //!!! az: I added the +1. JS community does without. But incorrect, right!?!?
  return(ee.Date(date))
}



// COMPUTE --------------------------


// map over granule list
var results = granules.map(function(g){


  // Load one GEDI orbit
  var gedi = ee.FeatureCollection(g[0]);
  //var gedi_date = ee.Date(g[1])
  var gedi_date = name2date(g[0])


  gedi = gedi.filterBounds(hessen)
  .filter(ee.Filter.eq("l2b_quality_flag", 1))
  .filter(ee.Filter.gt("sensitivity", 0.9))
  .filter(ee.Filter.neq("pai", null));
  /*
  // Filter a small amount of points in the orbit
  gedi = gedi.filterBounds(hessen).randomColumn();
  var gedi_sample = gedi.filter(ee.Filter.lt("random", 0.03));
  */
  //while testing:
  var gedi_sample = gedi
  // Buffer the points and add time as property
  gedi_sample = gedi_sample.map(function(f){return f.buffer(12.5).set({time: gedi_date})})
  //print(gedi_sample)

//print("gedi buffer size: ", gedi_sample.size())
//print(gedi_sample, "W Time")
    // calc time difference to gedi date
  var temporalMatch = function(image){
      var timediff = gedi_date.difference(ee.Date(image.get("system:time_start")), "day").abs()
      return image.set({timediff: timediff})
    };


  // Load Sentinel 2 Surface Reflectance and apply the filtering
  // Uses start and end date specified in the granule list
  var sen2 = ee.ImageCollection('COPERNICUS/S2_SR')
    .filterBounds(gedi_sample)
    .filterDate(gedi_date.advance(-5, "day"), gedi_date.advance(5, "day")) // +- 5 days of gedi orbit
    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 50)) // less than 80% cloud cover
    .select('B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B9', 'B11', 'B12', 'SCL')
    .map(function(image){
      var idate = ee.Number.parse(image.date().format("YYYYDDD"))
      var dateBand = ee.Image.constant(idate).uint32().rename('S2time')
      return(image.addBands(dateBand))
    })
    .map(S2_SR_indices)
    .map(temporalMatch)
    .sort("timediff")
    .mosaic()


  var sen1 = ee.ImageCollection("COPERNICUS/S1_GRD")
  .filterBounds(gedi_sample)
  .filterDate(gedi_date.advance(-3, "day"), gedi_date.advance(3, "day")) // +- 3 days of gedi orbit
  .filter(ee.Filter.listContains('transmitterReceiverPolarisation', "VV"))
  .filter(ee.Filter.listContains('transmitterReceiverPolarisation', "VH"))
  .filter(ee.Filter.eq('instrumentMode', 'IW'))
  .select("VV", "VH")
  .map(function(image){
      var idate = ee.Number.parse(image.date().format("YYYYDDD"));
      var dateBand = ee.Image.constant(idate).uint32().rename('S1time')
      return(image.addBands(dateBand))
    })
  .map(sen1vvvh)
  .map(temporalMatch)
  .sort("timediff")
  .mosaic();

  var stack = sen2.addBands(sen1)

  var sampledPoints = stack.sampleRegions({
  collection: gedi_sample,
  scale: 10,
  properties: ['time','pai', "beam", "degrade_flag", "l2b_quality_flag",
  "orbit_number", "sensitivity", "shot_number", "shot_number_within_beam",
  "solar_azimuth", "solar_elevation", "id"],
  geometries: true
})
/*
//visually check distribution of GEDI hulls
Map.centerObject(hessen)
var gediHull = gedi.geometry().convexHull();
Map.addLayer(gediHull, undefined, "gediHull");
*/
//print(g)
  //print("sampled_Points: ", sampledPoints.size())
  return sampledPoints

})

//print(results, "Sampled Points")



var resultsCollection = ee.FeatureCollection(results).flatten()

//print(resultsCollection.first(), "RES")


//print("size result collection: ", resultsCollection.size())
// save each GEDI orbit in a different file


Export.table.toDrive({
    collection: resultsCollection,
    description: "Res",
    fileNamePrefix: "gedi_",
    folder: "gedi"
  })
